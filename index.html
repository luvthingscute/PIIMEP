<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Visualizador PIIMEP Quilpué</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;}
#map{width:100vw;height:100vh;}

.tabla-box{
  position:absolute; top:10px; left:10px; z-index:9999;
  background:rgba(255,255,255,0.95); padding:10px; border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,0.25); max-height:260px; overflow:auto;
  width:360px;
}
.tabla-toggle{
  cursor:pointer; font-family:Arial; font-size:12px; font-weight:bold;
  background:#eeeeee; color:#333333; border:none;
  padding:6px 10px; border-radius:8px; width:100%; margin-bottom:8px; text-align:left;
}
table{border-collapse:collapse; width:100%; font-size:12px;}
th,td{border:1px solid #ccc; padding:4px; text-align:center;}
th:first-child, td:first-child{text-align:left;}
/* colores columnas como tu kable */
.col-ep{background:#abd4a0;}
.col-mov{background:#f3cb44;}
.col-int{background:#eb9890;}

.logos-container{
  position:absolute; bottom:10px; left:90px; z-index:9999;
  display:flex; gap:12px; align-items:center; background:rgba(255,255,255,0.9);
  padding:10px 15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2);
}
.logos-container img{height:50px; width:auto;}
.logos-text{font-family:Arial,sans-serif; font-size:11px; color:#333; margin-left:10px; white-space:nowrap;}
</style>
</head>

<body>
<div id="map"></div>

<!-- Tabla plegable -->
<div class="tabla-box">
  <button class="tabla-toggle" onclick="toggleTabla()">▼ Resumen por sector</button>
  <div id="tabla"></div>
</div>

<!-- Logos -->
<div class="logos-container">
  <img src="img/LOGO_QUILPUE.png" alt="Quilpué">
  <img src="img/GORE_VALPARAISO.png" alt="GORE Valparaíso">
  <img src="img/Logo%20DESE%20UC_negro.png" alt="DESE UC">
  <span class="logos-text">Por: DESE UC y Florencia Muñoz-Obon</span>
</div>

<script>
// =====================
// MAPA BASE + PANES
// =====================
const map = L.map('map', { preferCanvas: true });

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution:'©OpenStreetMap ©Carto'
}).addTo(map);

// panes para controlar quién queda arriba y asegurar clicks
map.createPane('paneComuna'); map.getPane('paneComuna').style.zIndex = 200;
map.createPane('paneUT');     map.getPane('paneUT').style.zIndex     = 300;
map.createPane('paneProy');   map.getPane('paneProy').style.zIndex   = 500; // proyectos arriba

// =====================
// HELPERS (robustos)
// =====================

// lee propiedad probando varias claves (por si cambiaron nombres)
function prop(p, keys){
  for(const k of keys){
    if(p && p[k] !== undefined && p[k] !== null && String(p[k]).trim() !== "") return p[k];
  }
  return "";
}

function normTipo(x){
  if(!x) return "";
  return String(x)
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // saca tildes
    .replace(/\s+/g," ")
    .trim();
}

function colorPorTipo(t){
  const tt = normTipo(t);
  if(tt === "integral") return "#eb9890";
  if(tt.includes("integral")) return "#eb9890";
  if(tt.includes("movilidad")) return "#f3cb44";
  if(tt.includes("espacio publico") || tt.includes("espacios publicos") || tt.includes("espacio publico")) return "#abd4a0";
  if(tt.includes("espacio")) return "#abd4a0";
  return "#BDBDBD";
}

// popup estilo R: Código + Tipo + Nombre
function popupProyecto(props){
  const tipo = prop(props, ["Tipo_de_pr","TIPO_DE_PR","tipo","Tipo"]);
  const nombre = prop(props, ["Nombre_de_","NOMBRE_DE_","nombre","Nombre"]);
  const codigo = prop(props, ["CÓDIGO","CODIGO","Código_pr","Codigo_pr","CODIGO_PR"]);
  const col = colorPorTipo(tipo);

  return `
    <b style="color:${col}; font-size:14px;">Proyecto</b><br>
    <b>Código:</b> ${codigo ? codigo : "Sin código"}<br>
    <b>Tipo de proyecto:</b> ${tipo ? tipo : "Sin tipo de proyecto"}<br>
    <b>Nombre:</b> ${nombre ? nombre : "Sin nombre"}
  `;
}

// =====================
// LAYERS CONTROL (como tu R)
// =====================
const baseMaps = {}; // (si después quieres Carto oscuro/OSM, te lo agrego)
const overlays = {}; // aquí van "Comuna", sectores UT, "Polígonos", "Líneas", "Puntos"

const layerControl = L.control.layers(baseMaps, overlays, { collapsed:false }).addTo(map);

// =====================
// CARGAR COMUNA
// =====================
fetch("data/COMUNA.geojson").then(r=>r.json()).then(gj=>{
  const layer = L.geoJSON(gj, {
    pane:'paneComuna',
    interactive:false,
    style:{ color:"#7c0a6e", weight:2, opacity:1, fillOpacity:0 }
  }).addTo(map);

  overlays["Comuna"] = layer;
  layerControl.addOverlay(layer, "Comuna");
});

// =====================
// CARGAR UT POR SECTOR (como tu loop en R)
// =====================
fetch("data/UT_QUILPUE.geojson").then(r=>r.json()).then(gj=>{
  // fitbounds con UT (como tu bbox UT)
  const utLayerAll = L.geoJSON(gj);
  map.fitBounds(utLayerAll.getBounds());

  // agrupar features por SECTOR
  const bySector = new Map();
  for(const f of gj.features){
    const s = prop(f.properties, ["SECTOR","Sector","sector"]) || "SIN_NOMBRE";
    if(!bySector.has(s)) bySector.set(s, []);
    bySector.get(s).push(f);
  }

  // crear una capa por sector
  for(const [sector, feats] of bySector.entries()){
    const sectorGJ = { type:"FeatureCollection", features: feats };

    const layer = L.geoJSON(sectorGJ, {
      pane:'paneUT',
      interactive:false, // CLAVE: no bloquear clicks de proyectos
      style:{ color:"#7a0f3a", weight:2, opacity:0.95, fillOpacity:0 },
      // label tipo R: Leaflet JS no tiene label nativo igual, pero tooltip lo reemplaza
      onEachFeature:(f,l)=>{
        l.bindTooltip(String(sector), { direction:"auto", sticky:false, opacity:0.9 });
      }
    }).addTo(map);

    overlays[sector] = layer;
    layerControl.addOverlay(layer, sector);
  }
});

// =====================
// POLIGONOS (popups + highlight)
// =====================
fetch("data/poligonos.geojson").then(r=>r.json()).then(gj=>{
  const layer = L.geoJSON(gj, {
    pane:'paneProy',
    interactive:true,
    style:(f)=>({
      color: colorPorTipo(prop(f.properties, ["Tipo_de_pr","TIPO_DE_PR","tipo","Tipo"])),
      fillColor: colorPorTipo(prop(f.properties, ["Tipo_de_pr","TIPO_DE_PR","tipo","Tipo"])),
      weight:2, opacity:0.9, fillOpacity:0.5
    }),
    onEachFeature:(f,l)=>{
      l.bindPopup(popupProyecto(f.properties));

      // highlight como R
      l.on("mouseover", ()=> l.setStyle({ color:"#333333", weight:3, fillOpacity:0.6 }));
      l.on("mouseout",  ()=> layer.resetStyle(l));
    }
  }).addTo(map);

  overlays["Polígonos"] = layer;
  layerControl.addOverlay(layer, "Polígonos");
});

// =====================
// LINEAS (popups + highlight)
// =====================
fetch("data/lineas3.geojson").then(r=>r.json()).then(gj=>{
  const layer = L.geoJSON(gj, {
    pane:'paneProy',
    interactive:true,
    style:(f)=>({
      color: colorPorTipo(prop(f.properties, ["Tipo_de_pr","TIPO_DE_PR","tipo","Tipo"])),
      weight:4, opacity:0.9
    }),
    onEachFeature:(f,l)=>{
      l.bindPopup(popupProyecto(f.properties));
      l.on("mouseover", ()=> l.setStyle({ color:"#333333", weight:6 }));
      l.on("mouseout",  ()=> layer.resetStyle(l));
    }
  }).addTo(map);

  overlays["Líneas"] = layer;
  layerControl.addOverlay(layer, "Líneas");
});

// =====================
// PUNTOS (popups)
// =====================
fetch("data/puntos2.geojson").then(r=>r.json()).then(gj=>{
  const layer = L.geoJSON(gj, {
    pane:'paneProy',
    interactive:true,
    pointToLayer:(f,latlng)=>{
      const col = colorPorTipo(prop(f.properties, ["Tipo_de_pr","TIPO_DE_PR","tipo","Tipo"]));
      return L.circleMarker(latlng, {
        radius:6, color:col, fillColor:col, weight:2, opacity:0.9, fillOpacity:0.85
      });
    },
    onEachFeature:(f,l)=>{
      l.bindPopup(popupProyecto(f.properties));
    }
  }).addTo(map);

  overlays["Puntos"] = layer;
  layerControl.addOverlay(layer, "Puntos");
});

// =====================
// TABLA CSV (sin comillas feas)
// =====================
fetch("data/TABLA_2.csv").then(r=>r.text()).then(txt=>{
  const rows = txt.trim().split(/\r?\n/).map(line=>{
    // separa por coma y limpia comillas
    return line.split(",").map(c=>c.replace(/^"|"$/g,"").trim());
  });

  // Esperamos columnas: Sector, Espacio Público, Integral, Movilidad, Total general
  // armamos tabla con colores por columna (2 EP, 3 Integral, 4 Movilidad)
  let html = "<table><thead><tr>";
  const header = rows[0] || [];
  header.forEach((h,i)=>{
    let cls = "";
    if(i===1) cls="col-ep";
    if(i===2) cls="col-int";
    if(i===3) cls="col-mov";
    html += `<th class="${cls}">${h}</th>`;
  });
  html += "</tr></thead><tbody>";

  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(r.length===0) continue;
    html += "<tr>";
    r.forEach((c,j)=>{
      let cls = "";
      if(j===1) cls="col-ep";
      if(j===2) cls="col-int";
      if(j===3) cls="col-mov";
      html += `<td class="${cls}">${c}</td>`;
    });
    html += "</tr>";
  }
  html += "</tbody></table>";

  document.getElementById("tabla").innerHTML = html;
});

function toggleTabla(){
  const d=document.getElementById("tabla");
  const b=document.querySelector(".tabla-toggle");
  if(d.style.display==="none"){
    d.style.display="block"; b.innerHTML="▼ Resumen por sector";
  }else{
    d.style.display="none"; b.innerHTML="▶ Resumen por sector";
  }
}
</script>
</body>
</html>
