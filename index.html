<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Visualizador PIIMEP Quilpué</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MiniMap plugin (si falla, NO rompe el mapa) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap@3.6.1/dist/Control.MiniMap.min.css"/>
<script src="https://unpkg.com/leaflet-minimap@3.6.1/dist/Control.MiniMap.min.js"></script>

<style>
:root{ --ui-font: Arial, sans-serif; }
html, body, #map, .leaflet-container, .leaflet-control, .leaflet-popup-content, .leaflet-tooltip{
  font-family: var(--ui-font) !important;
}
html,body{margin:0;padding:0;}
#map{width:100vw;height:100vh;}

/* Tabla */
.tabla-box{
  position:absolute; top:10px; left:10px; z-index:9999;
  background:rgba(255,255,255,0.95); padding:10px; border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,0.25); max-height:260px; overflow:auto;
  width:360px;
}
.tabla-toggle{
  cursor:pointer; font-size:12px; font-weight:bold;
  background:#eeeeee; color:#333333; border:none;
  padding:6px 10px; border-radius:8px; width:100%; margin-bottom:8px; text-align:left;
}
table{border-collapse:collapse; width:100%; font-size:12px;}
th,td{border:1px solid #ccc; padding:4px; text-align:center;}
th:first-child, td:first-child{text-align:left;}
.col-ep{background:#abd4a0;}
.col-mov{background:#f3cb44;}
.col-int{background:#eb9890;}

/* Logos */
.logos-container{
  position:absolute; bottom:10px; left:90px; z-index:9999;
  display:flex; gap:12px; align-items:center; background:rgba(255,255,255,0.9);
  padding:10px 15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2);
}
.logos-container img{height:50px; width:auto;}
.logos-text{font-size:11px; color:#333; margin-left:10px; white-space:nowrap;}

/* Leyenda */
.legend{
  background: rgba(255,255,255,0.95);
  padding: 10px 12px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.25);
  font-size: 12px;
  line-height: 1.35;
}
.legend .row{display:flex; align-items:center; gap:8px; margin:4px 0;}
.legend .sw{width:14px; height:14px; border-radius:4px; border:1px solid #999;}
.legend .ttl{font-weight:700; margin-bottom:6px;}
</style>
</head>

<body>
<div id="map"></div>

<div class="tabla-box">
  <button class="tabla-toggle" onclick="toggleTabla()">▼ Resumen por sector</button>
  <div id="tabla"></div>
</div>

<div class="logos-container">
  <img src="img/LOGO_QUILPUE.png" alt="Quilpué">
  <img src="img/GORE_VALPARAISO.png" alt="GORE Valparaíso">
  <img src="img/Logo%20DESE%20UC_negro.png" alt="DESE UC">
  <span class="logos-text">Por: DESE UC y Florencia Muñoz-Obon</span>
</div>

<script>
// =====================
// MAPA + BASE (OSM seguro)
// =====================
const map = L.map('map', { preferCanvas: true });

// vista inicial por si los geojson fallan
map.setView([-33.05, -71.45], 12);

// base OSM (segura)
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '©OpenStreetMap'
}).addTo(map);

// opcional: Carto light (si quieres)
const cartoLight = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
  { attribution:'©OpenStreetMap ©Carto' }
);

const layerControl = L.control.layers(
  { "OSM": osm, "Carto Claro": cartoLight },
  {},
  { collapsed:false }
).addTo(map);

// MiniMap (si plugin falla, no rompe)
try{
  if (L.Control && L.Control.MiniMap){
    const mini = new L.Control.MiniMap(
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'©OpenStreetMap' }),
      { toggleDisplay:true, position:'bottomright', width:180, height:180, zoomLevelFixed:10 }
    );
    map.addControl(mini);
  }
}catch(e){
  console.warn("MiniMap no cargó:", e);
}

// =====================
// PANES (orden para que popups sí funcionen)
// =====================
map.createPane('paneComuna'); map.getPane('paneComuna').style.zIndex = 200;
map.createPane('paneUT');     map.getPane('paneUT').style.zIndex     = 300;
map.createPane('panePoly');   map.getPane('panePoly').style.zIndex   = 500;
map.createPane('paneLine');   map.getPane('paneLine').style.zIndex   = 600;
map.createPane('panePoint');  map.getPane('panePoint').style.zIndex  = 700;

// =====================
// HELPERS
// =====================
function prop(p, keys){
  for(const k of keys){
    if(p && p[k] !== undefined && p[k] !== null && String(p[k]).trim() !== "") return p[k];
  }
  return "";
}
function normTipo(x){
  if(!x) return "";
  return String(x)
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ")
    .trim();
}
function colorPorTipo(t){
  const tt = normTipo(t);
  if(tt === "integral") return "#eb9890";
  if(tt.includes("integral")) return "#eb9890";
  if(tt.includes("movilidad")) return "#f3cb44";
  if(tt.includes("espacio publico") || tt.includes("espacios publicos") || tt.includes("espacio público")) return "#abd4a0";
  if(tt.includes("espacio")) return "#abd4a0";
  return "#BDBDBD";
}
function toTitleCase(str){
  return String(str)
    .toLowerCase()
    .replace(/\s+/g," ")
    .trim()
    .split(" ")
    .map(w => w ? w[0].toUpperCase() + w.slice(1) : w)
    .join(" ");
}
function popupProyecto(props){
  const tipo   = prop(props, ["Tipo_de_pr","TIPO_DE_PR","tipo","Tipo"]);
  const nombre = prop(props, ["Nombre_de_","NOMBRE_DE_","nombre","Nombre"]);
  const codigo = prop(props, ["CÓDIGO","CODIGO","Código_pr","Codigo_pr","CODIGO_PR"]);
  const col = colorPorTipo(tipo);

  return `
    <b style="color:${col}; font-size:14px;">Proyecto</b><br>
    <b>Código:</b> ${codigo ? codigo : "Sin código"}<br>
    <b>Tipo de proyecto:</b> ${tipo ? tipo : "Sin tipo de proyecto"}<br>
    <b>Nombre:</b> ${nombre ? nombre : "Sin nombre"}
  `;
}
async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(`${url} -> ${r.status} ${r.statusText}`);
  return await r.json();
}

// =====================
// COMUNA
// =====================
fetchJSON("data/COMUNA.geojson")
  .then(gj=>{
    const layer = L.geoJSON(gj, {
      pane:'paneComuna',
      interactive:false,
      style:{ color:"#7c0a6e", weight:2, opacity:1, fillOpacity:0 }
    }).addTo(map);
    layerControl.addOverlay(layer, "Comuna");
  })
  .catch(err=>console.error("COMUNA:", err));

// =====================
// UT POR SECTOR (hover)
// =====================
fetchJSON("data/UT_QUILPUE.geojson")
  .then(gj=>{
    const tmp = L.geoJSON(gj);
    map.fitBounds(tmp.getBounds());

    const bySector = new Map();
    for(const f of gj.features){
      const sRaw = prop(f.properties, ["SECTOR","Sector","sector"]) || "SIN NOMBRE";
      const s = toTitleCase(sRaw);
      if(!bySector.has(s)) bySector.set(s, []);
      bySector.get(s).push(f);
    }

    const sectorNames = Array.from(bySector.keys()).sort((a,b)=>a.localeCompare(b,"es"));
    for(const sector of sectorNames){
      const sectorGJ = { type:"FeatureCollection", features: bySector.get(sector) };

      const layer = L.geoJSON(sectorGJ, {
        pane:'paneUT',
        interactive:true,
        style:{ color:"#7a0f3a", weight:2, opacity:0.95, fillOpacity:0 },
        onEachFeature:(f,l)=>{
          l.bindTooltip(String(sector), { direction:"auto", sticky:true, opacity:0.9 });
        }
      }).addTo(map);

      layerControl.addOverlay(layer, sector);
    }
  })
  .catch(err=>console.error("UT:", err));

// =====================
// POLIGONOS
// =====================
fetchJSON("data/poligonos.geojson")
  .then(gj=>{
    const layer = L.geoJSON(gj, {
      pane:'panePoly',
      interactive:true,
      style:(f)=>({
        color: colorPorTipo(prop(f.properties, ["Tipo_de_pr","TIPO_DE_PR","tipo","Tipo"])),
        fillColor: colorPorTipo(prop(f.properties, ["Tipo_de_pr","TIPO_DE_PR","tipo","Tipo"])),
        weight:2, opacity:0.9, fillOpacity:0.5
      }),
      onEachFeature:(f,l)=>{
        l.bindPopup(popupProyecto(f.properties));
        l.on("mouseover", ()=> l.setStyle({ color:"#333333", weight:3, fillOpacity:0.6 }));
        l.on("mouseout",  ()=> layer.resetStyle(l));
      }
    }).addTo(map);

    layerControl.addOverlay(layer, "Polígonos");
  })
  .catch(err=>console.error("Polígonos:", err));

// =====================
// LINEAS
// =====================
fetchJSON("data/lineas3.geojson")
  .then(gj=>{
    const layer = L.geoJSON(gj, {
      pane:'paneLine',
      interactive:true,
      style:(f)=>({
        color: colorPorTipo(prop(f.properties, ["Tipo_de_pr","TIPO_DE_PR","tipo","Tipo"])),
        weight:4, opacity:0.9
      }),
      onEachFeature:(f,l)=>{
        l.bindPopup(popupProyecto(f.properties));
        l.on("mouseover", ()=> l.setStyle({ color:"#333333", weight:6 }));
        l.on("mouseout",  ()=> layer.resetStyle(l));
      }
    }).addTo(map);

    layerControl.addOverlay(layer, "Líneas");
  })
  .catch(err=>console.error("Líneas:", err));

// =====================
// PUNTOS (arriba de todo)
// =====================
fetchJSON("data/puntos2.geojson")
  .then(gj=>{
    const layer = L.geoJSON(gj, {
      pane:'panePoint',
      interactive:true,
      pointToLayer:(f,latlng)=>{
        const col = colorPorTipo(prop(f.properties, ["Tipo_de_pr","TIPO_DE_PR","tipo","Tipo"]));
        return L.circleMarker(latlng, {
          radius:6, color:col, fillColor:col, weight:2, opacity:0.9, fillOpacity:0.85
        });
      },
      onEachFeature:(f,l)=>{
        l.bindPopup(popupProyecto(f.properties), { autoPan:true, closeButton:true });
      }
    }).addTo(map);

    layerControl.addOverlay(layer, "Puntos");
  })
  .catch(err=>console.error("Puntos:", err));

// =====================
// LEYENDA
// =====================
const legend = L.control({position:'bottomright'});
legend.onAdd = function(){
  const div = L.DomUtil.create('div','legend');
  div.innerHTML = `
    <div class="ttl">Leyenda</div>
    <div class="row"><span class="sw" style="background:#f3cb44"></span> Movilidad</div>
    <div class="row"><span class="sw" style="background:#eb9890"></span> Integrales</div>
    <div class="row"><span class="sw" style="background:#abd4a0"></span> Espacio público</div>
  `;
  return div;
};
legend.addTo(map);

// =====================
// TABLA CSV
// =====================
fetch("data/TABLA_2.csv")
  .then(r=>{
    if(!r.ok) throw new Error(`TABLA_2.csv -> ${r.status} ${r.statusText}`);
    return r.text();
  })
  .then(txt=>{
    const rows = txt.trim().split(/\r?\n/).map(line =>
      line.split(",").map(c=>c.replace(/^"|"$/g,"").trim())
    );
    const header = rows[0] || [];
    let html = "<table><thead><tr>";
    header.forEach((h,i)=>{
      let cls="";
      if(i===1) cls="col-ep";
      if(i===2) cls="col-int";
      if(i===3) cls="col-mov";
      html += `<th class="${cls}">${h}</th>`;
    });
    html += "</tr></thead><tbody>";

    for(let i=1;i<rows.length;i++){
      const r = rows[i]; if(!r || !r.length) continue;
      html += "<tr>";
      r.forEach((c,j)=>{
        let cls="";
        if(j===1) cls="col-ep";
        if(j===2) cls="col-int";
        if(j===3) cls="col-mov";
        html += `<td class="${cls}">${c}</td>`;
      });
      html += "</tr>";
    }
    html += "</tbody></table>";
    document.getElementById("tabla").innerHTML = html;
  })
  .catch(err=>console.error("Tabla:", err));

function toggleTabla(){
  const d=document.getElementById("tabla");
  const b=document.querySelector(".tabla-toggle");
  if(d.style.display==="none"){
    d.style.display="block"; b.innerHTML="▼ Resumen por sector";
  }else{
    d.style.display="none"; b.innerHTML="▶ Resumen por sector";
  }
}
</script>
</body>
</html>
