<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Visualizador PIIMEP Quilpué</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;}
#map{width:100vw;height:100vh;}

.logos{
 position:absolute;
 bottom:10px;
 left:10px;
 background:white;
 padding:8px;
 border-radius:8px;
 display:flex;
 gap:10px;
 z-index:999;
}
.logos img{height:45px;}

.tabla-box{
 position:absolute;
 top:10px;
 left:10px;
 background:white;
 padding:8px;
 border-radius:8px;
 max-height:250px;
 overflow:auto;
 z-index:999;
 width:360px;
}
.tabla-toggle{
 width:100%;
 border:none;
 padding:6px;
 font-weight:bold;
 cursor:pointer;
 background:#eee;
 border-radius:6px;
}
table{
 border-collapse:collapse;
 width:100%;
 font-size:12px;
}
th,td{
 border:1px solid #ccc;
 padding:4px;
 text-align:center;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="tabla-box">
<button class="tabla-toggle" onclick="toggleTabla()">▼ Resumen por sector</button>
<div id="tabla"></div>
</div>

<div class="logos">
<img src="img/LOGO_QUILPUE.png">
<img src="img/GORE_VALPARAISO.png">
<img src="img/Logo_DESE_UC_negro.png">
</div>

<script>

const map = L.map('map').setView([-33.05,-71.45],12);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
 attribution:'©OSM ©Carto'
}).addTo(map);

// ----------------
function colorPorTipo(t){
 if(!t) return "#BDBDBD";
 t=t.toLowerCase();
 if(t.includes("movilidad")) return "#f3cb44";
 if(t.includes("integral")) return "#eb9890";
 if(t.includes("espacio")) return "#abd4a0";
 return "#BDBDBD";
}

// ---------------- COMUNA
fetch("data/COMUNA.geojson")
.then(r=>r.json())
.then(d=>{
 L.geoJSON(d,{style:{color:"#7c0a6e",weight:2,fillOpacity:0}}).addTo(map);
});

// ---------------- UT
fetch("data/UT_QUILPUE.geojson")
.then(r=>r.json())
.then(d=>{
 L.geoJSON(d,{style:{color:"#7a0f3a",weight:1,fillOpacity:0}}).addTo(map);
});

// ---------------- POLIGONOS
fetch("data/poligonos.geojson")
.then(r=>r.json())
.then(d=>{
 L.geoJSON(d,{
  style:f=>({
   color:colorPorTipo(f.properties.Tipo_de_pr),
   fillColor:colorPorTipo(f.properties.Tipo_de_pr),
   weight:2,
   fillOpacity:0.5
  }),
  onEachFeature:(f,l)=>{
   l.bindPopup(`<b style="color:${colorPorTipo(f.properties.Tipo_de_pr)}">Proyecto</b><br>
   <b>Tipo:</b> ${f.properties.Tipo_de_pr||"Sin dato"}<br>
   <b>Nombre:</b> ${f.properties.Nombre_de_||"Sin nombre"}`);
  }
 }).addTo(map);
});

// ---------------- LINEAS
fetch("data/lineas3.geojson")
.then(r=>r.json())
.then(d=>{
 L.geoJSON(d,{
  style:f=>({color:colorPorTipo(f.properties.Tipo_de_pr),weight:4}),
  onEachFeature:(f,l)=>{
   l.bindPopup(`<b style="color:${colorPorTipo(f.properties.Tipo_de_pr)}">Proyecto</b><br>
   <b>Tipo:</b> ${f.properties.Tipo_de_pr||"Sin dato"}<br>
   <b>Nombre:</b> ${f.properties.Nombre_de_||"Sin nombre"}`);
  }
 }).addTo(map);
});

// ---------------- PUNTOS
fetch("data/puntos2.geojson")
.then(r=>r.json())
.then(d=>{
 L.geoJSON(d,{
  pointToLayer:(f,latlng)=>{
   return L.circleMarker(latlng,{
    radius:6,
    color:colorPorTipo(f.properties.Tipo_de_pr),
    fillColor:colorPorTipo(f.properties.Tipo_de_pr),
    fillOpacity:0.9
   });
  },
  onEachFeature:(f,l)=>{
   l.bindPopup(`<b style="color:${colorPorTipo(f.properties.Tipo_de_pr)}">Proyecto</b><br>
   <b>Tipo:</b> ${f.properties.Tipo_de_pr||"Sin dato"}<br>
   <b>Nombre:</b> ${f.properties.Nombre_de_||"Sin nombre"}`);
  }
 }).addTo(map);
});

// ---------------- TABLA CSV
fetch("data/TABLA_2.csv")
.then(r=>r.text())
.then(t=>{
 let rows=t.split("\n").map(r=>r.split(","));
 let html="<table>";
 rows.forEach((r,i)=>{
  html+="<tr>";
  r.forEach(c=>{
   html+= i==0 ? `<th>${c}</th>`:`<td>${c}</td>`;
  });
  html+="</tr>";
 });
 html+="</table>";
 document.getElementById("tabla").innerHTML=html;
});

function toggleTabla(){
 let d=document.getElementById("tabla");
 let b=document.querySelector(".tabla-toggle");
 if(d.style.display==="none"){
  d.style.display="block"; b.innerHTML="▼ Resumen por sector";
 }else{
  d.style.display="none"; b.innerHTML="▶ Resumen por sector";
 }
}

</script>
</body>
</html>
