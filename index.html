<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Visualizador PIIMEP Quilpué</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css"/>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

<style>
html,body,#map{height:100%;margin:0;}

.tabla-box{
position:absolute;
top:10px; left:10px;
background:white;
padding:10px;
border-radius:8px;
z-index:999;
max-height:260px;
overflow:auto;
font-family:Arial;
}

.logos{
position:absolute;
bottom:10px; left:80px;
background:white;
padding:10px;
border-radius:8px;
display:flex;
gap:10px;
align-items:center;
z-index:999;
}

.logos img{height:45px;}
</style>
</head>

<body>
<div id="map"></div>

<div class="tabla-box">
<b>Resumen por sector</b>
<table border="1" cellpadding="4">
<tr>
<th>Sector</th>
<th style="background:#abd4a0">Espacio Público</th>
<th style="background:#eb9890">Integral</th>
<th style="background:#f3cb44">Movilidad</th>
<th>Total</th>
</tr>
<tr><td>Belloto Centro</td><td>0</td><td>7</td><td>2</td><td>9</td></tr>
<tr><td>Belloto Norte</td><td>2</td><td>7</td><td>6</td><td>15</td></tr>
<tr><td>Belloto Sur</td><td>3</td><td>12</td><td>4</td><td>19</td></tr>
</table>
</div>

<div class="logos">
<img src="img/GORE_VALPARAISO.png">
<img src="img/LOGO_QUILPUE.png">
<img src="img/Logo_DESE_UC_negro.png">
<span>Por: DESE UC y Florencia Muñoz-Obon</span>
</div>

<script>

// =====================
// MAPA BASE
// =====================
const map = L.map("map").setView([-33.05,-71.45],13);

const carto = L.tileLayer(
"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"
).addTo(map);

// ESCALA
L.control.scale({
position:"bottomleft",
metric:true,
imperial:false
}).addTo(map);

// =====================
// COLORES
// =====================
function colorTipo(t){
if(!t) return "#999";
t = t.toLowerCase();
if(t.includes("movilidad")) return "#f3cb44";
if(t.includes("integral")) return "#eb9890";
if(t.includes("espacio")) return "#abd4a0";
return "#999";
}

// =====================
// COMUNA
// =====================
fetch("data/COMUNA.geojson")
.then(r=>r.json())
.then(d=>{
L.geoJSON(d,{
style:{color:"#7c0a6e",weight:2,fillOpacity:0}
}).addTo(map);
});

// =====================
// POLIGONOS
// =====================
fetch("data/poligonos.geojson")
.then(r=>r.json())
.then(d=>{
L.geoJSON(d,{
style:f=>({
color:colorTipo(f.properties.Tipo_de_pr),
fillColor:colorTipo(f.properties.Tipo_de_pr),
fillOpacity:0.5,
weight:2
}),
onEachFeature:(f,l)=>{
let p=f.properties;
l.bindPopup(`
<b style="color:${colorTipo(p.Tipo_de_pr)}">Proyecto</b><br>
<b>Código:</b> ${p.Código_pr || "Sin código"}<br>
<b>Tipo:</b> ${p.Tipo_de_pr || "Sin tipo"}<br>
<b>Nombre:</b> ${p.Nombre_de_ || "Sin nombre"}
`);
}
}).addTo(map);
});

// =====================
// LINEAS
// =====================
fetch("data/lineas3.geojson")
.then(r=>r.json())
.then(d=>{
L.geoJSON(d,{
style:f=>({
color:colorTipo(f.properties.Tipo_de_pr),
weight:4
}),
onEachFeature:(f,l)=>{
let p=f.properties;
l.bindPopup(`
<b>${p.Nombre_de_ || "Proyecto"}</b>
`);
}
}).addTo(map);
});

// =====================
// PUNTOS
// =====================
fetch("data/puntos2.geojson")
.then(r=>r.json())
.then(d=>{
L.geoJSON(d,{
pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
radius:6,
color:colorTipo(f.properties.Tipo_de_pr),
fillColor:colorTipo(f.properties.Tipo_de_pr),
fillOpacity:0.9
}),
onEachFeature:(f,l)=>{
let p=f.properties;
l.bindPopup(`
<b style="color:${colorTipo(p.Tipo_de_pr)}">Proyecto</b><br>
<b>Código:</b> ${p.Código_pr || "Sin código"}<br>
<b>Tipo:</b> ${p.Tipo_de_pr || "Sin tipo"}<br>
<b>Nombre:</b> ${p.Nombre_de_ || "Sin nombre"}
`);
}
}).addTo(map);
});

// =====================
// MINIMAP
// =====================
const mini = new L.Control.MiniMap(
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),
{toggleDisplay:true}
);
mini.addTo(map);

</script>
</body>
</html>
